<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JaCoCo Scanner - é…ç½®ç®¡ç†</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .header h1 { color: #333; margin-bottom: 10px; }
        .header p { color: #666; }
        .card { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .card h2 { color: #333; margin-bottom: 15px; border-bottom: 2px solid #007bff; padding-bottom: 5px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; color: #333; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        .form-control:focus { outline: none; border-color: #007bff; box-shadow: 0 0 0 2px rgba(0,123,255,0.25); }
        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; transition: all 0.3s; }
        .btn-primary { background: #007bff; color: white; }
        .btn-primary:hover { background: #0056b3; }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #1e7e34; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-danger:hover { background: #c82333; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #545b62; }
        .table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .table th, .table td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        .table th { background: #f8f9fa; font-weight: 500; }
        .table tr:hover { background: #f8f9fa; }
        .alert { padding: 12px; border-radius: 4px; margin-bottom: 15px; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-danger { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .row { display: flex; gap: 20px; }
        .col { flex: 1; }
        .text-center { text-align: center; }
        .mt-3 { margin-top: 15px; }
        .mb-3 { margin-bottom: 15px; }
        .badge { padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 500; }
        .badge-primary { background: #007bff; color: white; }
        .badge-success { background: #28a745; color: white; }
        .badge-secondary { background: #6c757d; color: white; }
        .loading { display: none; text-align: center; padding: 20px; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #007bff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <!-- é¡µé¢æ ‡é¢˜ -->
        <div class="header">
            <h1>ğŸ”§ JaCoCo Scanner é…ç½®ç®¡ç†</h1>
            <p>ç®¡ç†é¡¹ç›®ä¸Larkæœºå™¨äººçš„æ˜ å°„å…³ç³»ï¼Œæ”¯æŒå®æ—¶é…ç½®å’Œç«‹å³ç”Ÿæ•ˆ</p>
            <div id="config-status" class="mt-3">
                <span class="badge badge-secondary">åŠ è½½ä¸­...</span>
            </div>
        </div>

        <!-- æ¶ˆæ¯æç¤º -->
        <div id="message-area"></div>

        <!-- æ·»åŠ æ–°é…ç½® -->
        <div class="card">
            <h2>â• æ·»åŠ é¡¹ç›®é…ç½®</h2>
            <form id="add-config-form">
                <div class="row">
                    <div class="col">
                        <div class="form-group">
                            <label for="git-url">Gitä»“åº“åœ°å€</label>
                            <input type="url" id="git-url" class="form-control" placeholder="http://git.example.com/project/repo.git" required>
                            <small style="color: #666;">æ”¯æŒHTTP/HTTPS Gitä»“åº“åœ°å€</small>
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-group">
                            <label for="project-name">é¡¹ç›®åç§°</label>
                            <input type="text" id="project-name" class="form-control" placeholder="è‡ªåŠ¨ä»Gitåœ°å€æå–" readonly>
                            <small style="color: #666;">ä»Gitåœ°å€è‡ªåŠ¨æå–ï¼Œå¯æ‰‹åŠ¨ä¿®æ”¹</small>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="bot-select">é€‰æ‹©Larkæœºå™¨äºº</label>
                    <select id="bot-select" class="form-control" required>
                        <option value="">è¯·é€‰æ‹©æœºå™¨äºº...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="webhook-url">Webhook URL</label>
                    <input type="url" id="webhook-url" class="form-control" placeholder="https://open.larksuite.com/open-apis/bot/v2/hook/..." readonly>
                    <small style="color: #666;">é€‰æ‹©æœºå™¨äººåè‡ªåŠ¨å¡«å……ï¼Œä¹Ÿå¯æ‰‹åŠ¨è¾“å…¥æ–°çš„URL</small>
                </div>
                
                <div class="text-center">
                    <button type="button" id="extract-btn" class="btn btn-secondary">ğŸ“ æå–é¡¹ç›®åç§°</button>
                    <button type="submit" class="btn btn-primary">ğŸ’¾ ä¿å­˜é…ç½®</button>
                    <button type="button" id="test-btn" class="btn btn-success">ğŸ§ª æµ‹è¯•é…ç½®</button>
                </div>
            </form>
        </div>

        <!-- å½“å‰é…ç½®åˆ—è¡¨ -->
        <div class="card">
            <h2>ğŸ“‹ å½“å‰é…ç½®</h2>
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>åŠ è½½ä¸­...</p>
            </div>
            <div id="config-list">
                <table class="table">
                    <thead>
                        <tr>
                            <th>é¡¹ç›®åç§°</th>
                            <th>Gitåœ°å€</th>
                            <th>æœºå™¨äºº</th>
                            <th>çŠ¶æ€</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="config-table-body">
                        <!-- åŠ¨æ€åŠ è½½ -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- æœºå™¨äººç®¡ç† -->
        <div class="card">
            <h2>ğŸ¤– æœºå™¨äººç®¡ç†</h2>
            <div id="bot-list">
                <table class="table">
                    <thead>
                        <tr>
                            <th>æœºå™¨äººID</th>
                            <th>åç§°</th>
                            <th>Webhook URL</th>
                            <th>çŠ¶æ€</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="bot-table-body">
                        <!-- åŠ¨æ€åŠ è½½ -->
                    </tbody>
                </table>
            </div>
            
            <div class="mt-3">
                <button type="button" id="add-bot-btn" class="btn btn-primary">â• æ·»åŠ æ–°æœºå™¨äºº</button>
                <button type="button" id="refresh-btn" class="btn btn-secondary">ğŸ”„ åˆ·æ–°æ•°æ®</button>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let bots = {};
        let mappings = {};

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadConfigStatus();
            loadBots();
            loadMappings();
            initEventListeners();
        });

        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
        function initEventListeners() {
            // Gitåœ°å€è¾“å…¥ç›‘å¬
            document.getElementById('git-url').addEventListener('input', function() {
                const url = this.value;
                if (url) {
                    extractProjectName(url);
                }
            });

            // æå–é¡¹ç›®åç§°æŒ‰é’®
            document.getElementById('extract-btn').addEventListener('click', function() {
                const url = document.getElementById('git-url').value;
                if (url) {
                    extractProjectName(url);
                } else {
                    showMessage('è¯·å…ˆè¾“å…¥Gitåœ°å€', 'danger');
                }
            });

            // æœºå™¨äººé€‰æ‹©ç›‘å¬
            document.getElementById('bot-select').addEventListener('change', function() {
                const botId = this.value;
                if (botId && bots[botId]) {
                    document.getElementById('webhook-url').value = bots[botId].webhook_url;
                } else {
                    document.getElementById('webhook-url').value = '';
                }
            });

            // è¡¨å•æäº¤
            document.getElementById('add-config-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveConfig();
            });

            // æµ‹è¯•é…ç½®æŒ‰é’®
            document.getElementById('test-btn').addEventListener('click', function() {
                testConfig();
            });

            // åˆ·æ–°æŒ‰é’®
            document.getElementById('refresh-btn').addEventListener('click', function() {
                loadBots();
                loadMappings();
            });
        }

        // æå–é¡¹ç›®åç§°
        function extractProjectName(gitUrl) {
            try {
                const url = new URL(gitUrl);
                const pathParts = url.pathname.split('/');
                let projectName = pathParts[pathParts.length - 1];
                
                // ç§»é™¤.gitåç¼€
                if (projectName.endsWith('.git')) {
                    projectName = projectName.slice(0, -4);
                }
                
                document.getElementById('project-name').value = projectName;
                document.getElementById('project-name').readOnly = false;
                
                showMessage(`é¡¹ç›®åç§°å·²æå–: ${projectName}`, 'success');
            } catch (error) {
                showMessage('Gitåœ°å€æ ¼å¼ä¸æ­£ç¡®', 'danger');
            }
        }

        // åŠ è½½é…ç½®çŠ¶æ€
        async function loadConfigStatus() {
            try {
                const response = await fetch('/config/status');
                const data = await response.json();

                if (data.status === 'success') {
                    const status = data.config_status;
                    const statusElement = document.getElementById('config-status');

                    let statusHtml = '';
                    if (status.environment === 'Docker') {
                        statusHtml = `
                            <span class="badge badge-success">ğŸ³ Dockerç¯å¢ƒ</span>
                            <span class="badge badge-primary">ğŸ’¾ é…ç½®æŒä¹…åŒ–</span>
                            <span class="badge badge-secondary">ğŸ¤– ${status.total_bots} ä¸ªæœºå™¨äºº</span>
                            <span class="badge badge-secondary">ğŸ“‹ ${status.total_mappings} ä¸ªæ˜ å°„</span>
                        `;
                    } else {
                        statusHtml = `
                            <span class="badge badge-info">ğŸ’» æœ¬åœ°ç¯å¢ƒ</span>
                            <span class="badge badge-secondary">ğŸ¤– ${status.total_bots} ä¸ªæœºå™¨äºº</span>
                            <span class="badge badge-secondary">ğŸ“‹ ${status.total_mappings} ä¸ªæ˜ å°„</span>
                        `;
                    }

                    statusElement.innerHTML = statusHtml;
                } else {
                    document.getElementById('config-status').innerHTML =
                        '<span class="badge badge-danger">âŒ çŠ¶æ€è·å–å¤±è´¥</span>';
                }
            } catch (error) {
                document.getElementById('config-status').innerHTML =
                    '<span class="badge badge-danger">âŒ ç½‘ç»œé”™è¯¯</span>';
            }
        }

        // åŠ è½½æœºå™¨äººåˆ—è¡¨
        async function loadBots() {
            try {
                const response = await fetch('/config/bots');
                const data = await response.json();
                
                if (data.status === 'success') {
                    bots = data.bots;
                    updateBotSelect();
                    updateBotTable();
                } else {
                    showMessage('åŠ è½½æœºå™¨äººåˆ—è¡¨å¤±è´¥: ' + data.message, 'danger');
                }
            } catch (error) {
                showMessage('ç½‘ç»œé”™è¯¯: ' + error.message, 'danger');
            }
        }

        // åŠ è½½æ˜ å°„é…ç½®
        async function loadMappings() {
            try {
                const response = await fetch('/config/mappings');
                const data = await response.json();
                
                if (data.status === 'success') {
                    mappings = data.mappings;
                    updateConfigTable();
                } else {
                    showMessage('åŠ è½½é…ç½®å¤±è´¥: ' + data.message, 'danger');
                }
            } catch (error) {
                showMessage('ç½‘ç»œé”™è¯¯: ' + error.message, 'danger');
            }
        }

        // æ›´æ–°æœºå™¨äººé€‰æ‹©æ¡†
        function updateBotSelect() {
            const select = document.getElementById('bot-select');
            select.innerHTML = '<option value="">è¯·é€‰æ‹©æœºå™¨äºº...</option>';
            
            for (const [botId, botConfig] of Object.entries(bots)) {
                const option = document.createElement('option');
                option.value = botId;
                option.textContent = `${botConfig.name} (${botId})`;
                select.appendChild(option);
            }
        }

        // æ›´æ–°æœºå™¨äººè¡¨æ ¼
        function updateBotTable() {
            const tbody = document.getElementById('bot-table-body');
            tbody.innerHTML = '';
            
            for (const [botId, botConfig] of Object.entries(bots)) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><span class="badge badge-primary">${botId}</span></td>
                    <td>${botConfig.name}</td>
                    <td><code>${botConfig.webhook_url.substring(0, 50)}...</code></td>
                    <td><span class="badge badge-success">æ´»è·ƒ</span></td>
                    <td>
                        <button class="btn btn-secondary" onclick="testBot('${botId}')">ğŸ§ª æµ‹è¯•</button>
                    </td>
                `;
                tbody.appendChild(row);
            }
        }

        // æ›´æ–°é…ç½®è¡¨æ ¼
        function updateConfigTable() {
            const tbody = document.getElementById('config-table-body');
            tbody.innerHTML = '';
            
            for (const [pattern, botId] of Object.entries(mappings)) {
                const botName = bots[botId] ? bots[botId].name : 'æœªçŸ¥æœºå™¨äºº';
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><code>${pattern}</code></td>
                    <td>-</td>
                    <td>${botName} <span class="badge badge-secondary">${botId}</span></td>
                    <td><span class="badge badge-success">å·²é…ç½®</span></td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteMapping('${pattern}')">ğŸ—‘ï¸ åˆ é™¤</button>
                    </td>
                `;
                tbody.appendChild(row);
            }
        }

        // ä¿å­˜é…ç½®
        async function saveConfig() {
            const gitUrl = document.getElementById('git-url').value;
            const projectName = document.getElementById('project-name').value;
            const botId = document.getElementById('bot-select').value;
            const webhookUrl = document.getElementById('webhook-url').value;

            if (!gitUrl || !projectName || !botId) {
                showMessage('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯', 'danger');
                return;
            }

            try {
                const response = await fetch('/config/mapping', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        project_name: projectName,
                        git_url: gitUrl,
                        bot_id: botId,
                        webhook_url: webhookUrl
                    })
                });

                const data = await response.json();
                
                if (data.status === 'success') {
                    showMessage('é…ç½®ä¿å­˜æˆåŠŸï¼', 'success');
                    document.getElementById('add-config-form').reset();
                    loadMappings(); // é‡æ–°åŠ è½½é…ç½®
                } else {
                    showMessage('ä¿å­˜å¤±è´¥: ' + data.message, 'danger');
                }
            } catch (error) {
                showMessage('ç½‘ç»œé”™è¯¯: ' + error.message, 'danger');
            }
        }

        // æµ‹è¯•é…ç½®
        async function testConfig() {
            const projectName = document.getElementById('project-name').value;
            
            if (!projectName) {
                showMessage('è¯·å…ˆè¾“å…¥é¡¹ç›®åç§°', 'danger');
                return;
            }

            try {
                const response = await fetch(`/config/test/${projectName}`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    showMessage(`æµ‹è¯•æˆåŠŸï¼é¡¹ç›® ${projectName} å°†ä½¿ç”¨æœºå™¨äºº: ${data.bot_config.name}`, 'success');
                } else {
                    showMessage('æµ‹è¯•å¤±è´¥: ' + data.message, 'danger');
                }
            } catch (error) {
                showMessage('ç½‘ç»œé”™è¯¯: ' + error.message, 'danger');
            }
        }

        // åˆ é™¤æ˜ å°„
        async function deleteMapping(pattern) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤æ˜ å°„ "${pattern}" å—ï¼Ÿ`)) {
                return;
            }

            try {
                const response = await fetch('/config/mapping', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        pattern: pattern
                    })
                });

                const data = await response.json();
                
                if (data.status === 'success') {
                    showMessage('æ˜ å°„åˆ é™¤æˆåŠŸï¼', 'success');
                    loadMappings(); // é‡æ–°åŠ è½½é…ç½®
                } else {
                    showMessage('åˆ é™¤å¤±è´¥: ' + data.message, 'danger');
                }
            } catch (error) {
                showMessage('ç½‘ç»œé”™è¯¯: ' + error.message, 'danger');
            }
        }

        // æµ‹è¯•æœºå™¨äºº
        async function testBot(botId) {
            showMessage(`æ­£åœ¨æµ‹è¯•æœºå™¨äºº ${botId}...`, 'info');
            
            try {
                const response = await fetch(`/config/bot/test/${botId}`, {
                    method: 'POST'
                });

                const data = await response.json();
                
                if (data.status === 'success') {
                    showMessage(`æœºå™¨äºº ${botId} æµ‹è¯•æˆåŠŸï¼`, 'success');
                } else {
                    showMessage(`æœºå™¨äºº ${botId} æµ‹è¯•å¤±è´¥: ${data.message}`, 'danger');
                }
            } catch (error) {
                showMessage('ç½‘ç»œé”™è¯¯: ' + error.message, 'danger');
            }
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type) {
            const messageArea = document.getElementById('message-area');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            messageArea.innerHTML = '';
            messageArea.appendChild(alertDiv);
            
            // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }
    </script>
</body>
</html>
