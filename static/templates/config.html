<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JaCoCo Scanner - é…ç½®ç®¡ç†</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .header h1 { color: #333; margin-bottom: 10px; }
        .header p { color: #666; }
        .card { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .card h2 { color: #333; margin-bottom: 15px; border-bottom: 2px solid #007bff; padding-bottom: 5px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; color: #333; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        .form-control:focus { outline: none; border-color: #007bff; box-shadow: 0 0 0 2px rgba(0,123,255,0.25); }
        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; transition: all 0.3s; }
        .btn-primary { background: #007bff; color: white; }
        .btn-primary:hover { background: #0056b3; }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #1e7e34; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-danger:hover { background: #c82333; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #545b62; }
        .table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .table th, .table td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        .table th { background: #f8f9fa; font-weight: 500; }
        .table tr:hover { background: #f8f9fa; }
        .alert { padding: 12px; border-radius: 4px; margin-bottom: 15px; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-danger { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .row { display: flex; gap: 20px; }
        .col { flex: 1; }
        .text-center { text-align: center; }
        .mt-3 { margin-top: 15px; }
        .mb-3 { margin-bottom: 15px; }
        .badge { padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 500; }
        .badge-primary { background: #007bff; color: white; }
        .badge-success { background: #28a745; color: white; }
        .badge-secondary { background: #6c757d; color: white; }
        .loading { display: none; text-align: center; padding: 20px; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #007bff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <!-- é¡µé¢æ ‡é¢˜ -->
        <div class="header">
            <h1>ğŸ”§ JaCoCo Scanner é…ç½®ç®¡ç†</h1>
            <p>ç®¡ç†é¡¹ç›®ä¸Larkæœºå™¨äººçš„æ˜ å°„å…³ç³»ï¼Œæ”¯æŒå®æ—¶é…ç½®å’Œç«‹å³ç”Ÿæ•ˆ</p>
            <div id="config-status" class="mt-3">
                <span class="badge badge-secondary">åŠ è½½ä¸­...</span>
            </div>
        </div>

        <!-- æ¶ˆæ¯æç¤º -->
        <div id="message-area"></div>

        <!-- æ·»åŠ æ–°é…ç½® -->
        <div class="card">
            <h2>â• æ·»åŠ é¡¹ç›®é…ç½®</h2>

            <!-- å•ä¸ªé¡¹ç›®é…ç½® -->
            <div id="single-project-config">
                <h3>ğŸ”§ å•ä¸ªé¡¹ç›®é…ç½®</h3>
                <form id="add-config-form">
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label for="git-url">Gitä»“åº“åœ°å€</label>
                                <input type="url" id="git-url" class="form-control" placeholder="http://git.example.com/project/repo.git" required>
                                <small style="color: #666;">æ”¯æŒHTTP/HTTPS Gitä»“åº“åœ°å€</small>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label for="project-name">é¡¹ç›®åç§°</label>
                                <input type="text" id="project-name" class="form-control" placeholder="è‡ªåŠ¨ä»Gitåœ°å€æå–" readonly>
                                <small style="color: #666;">ä»Gitåœ°å€è‡ªåŠ¨æå–ï¼Œå¯æ‰‹åŠ¨ä¿®æ”¹</small>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label for="bot-select">é€‰æ‹©Larkæœºå™¨äºº</label>
                                <select id="bot-select" class="form-control" required>
                                    <option value="">è¯·é€‰æ‹©æœºå™¨äºº...</option>
                                    <option value="custom">ğŸ”§ è‡ªå®šä¹‰æœºå™¨äºº</option>
                                </select>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label for="webhook-url">Webhook URL</label>
                                <input type="url" id="webhook-url" class="form-control" placeholder="https://open.larksuite.com/open-apis/bot/v2/hook/...">
                                <small style="color: #666;">é€‰æ‹©æœºå™¨äººåè‡ªåŠ¨å¡«å……ï¼Œä¹Ÿå¯æ‰‹åŠ¨è¾“å…¥æ–°çš„URL</small>
                            </div>
                        </div>
                    </div>

                    <!-- è‡ªå®šä¹‰æœºå™¨äººé…ç½®åŒºåŸŸ -->
                    <div id="custom-bot-config" style="display: none;">
                        <div class="alert alert-info">
                            <strong>ğŸ”§ è‡ªå®šä¹‰æœºå™¨äººé…ç½®</strong><br>
                            è¯·è¾“å…¥æœºå™¨äººåç§°å’ŒWebhook URLï¼Œç³»ç»Ÿå°†è‡ªåŠ¨åˆ›å»ºæ–°çš„æœºå™¨äººé…ç½®ã€‚
                        </div>
                        <div class="form-group">
                            <label for="custom-bot-name">æœºå™¨äººåç§°</label>
                            <input type="text" id="custom-bot-name" class="form-control" placeholder="ä¾‹å¦‚ï¼šé¡¹ç›®Aä¸“ç”¨æœºå™¨äºº">
                        </div>
                    </div>

                    <div class="text-center">
                        <button type="button" id="extract-btn" class="btn btn-secondary">ğŸ“ æå–é¡¹ç›®åç§°</button>
                        <button type="submit" class="btn btn-primary">ğŸ’¾ ä¿å­˜é…ç½®</button>
                        <button type="button" id="test-btn" class="btn btn-success">ğŸ§ª æµ‹è¯•é…ç½®</button>
                    </div>
                </form>
            </div>

            <hr class="mt-3 mb-3">

            <!-- æ‰¹é‡é¡¹ç›®é…ç½® -->
            <div id="batch-project-config">
                <h3>ğŸ“¦ æ‰¹é‡é¡¹ç›®é…ç½®</h3>
                <div class="form-group">
                    <label for="batch-projects">æ‰¹é‡Gitåœ°å€ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰</label>
                    <textarea id="batch-projects" class="form-control" rows="5" placeholder="http://git.example.com/project1/repo1.git&#10;http://git.example.com/project2/repo2.git&#10;http://git.example.com/project3/repo3.git"></textarea>
                    <small style="color: #666;">æ¯è¡Œè¾“å…¥ä¸€ä¸ªGitä»“åº“åœ°å€ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨æå–é¡¹ç›®åç§°</small>
                </div>

                <div class="form-group">
                    <label for="batch-bot-select">é»˜è®¤æœºå™¨äºº</label>
                    <select id="batch-bot-select" class="form-control" required>
                        <option value="">è¯·é€‰æ‹©é»˜è®¤æœºå™¨äºº...</option>
                    </select>
                    <small style="color: #666;">æ‰¹é‡æ·»åŠ æ—¶ä½¿ç”¨çš„é»˜è®¤æœºå™¨äºº</small>
                </div>

                <div class="text-center">
                    <button type="button" id="batch-add-btn" class="btn btn-primary">ğŸ“¦ æ‰¹é‡æ·»åŠ </button>
                    <button type="button" id="batch-preview-btn" class="btn btn-secondary">ğŸ‘ï¸ é¢„è§ˆé¡¹ç›®</button>
                </div>

                <!-- æ‰¹é‡é¢„è§ˆç»“æœ -->
                <div id="batch-preview" style="display: none; margin-top: 15px;">
                    <h4>ğŸ“‹ é¢„è§ˆç»“æœ</h4>
                    <div id="batch-preview-content"></div>
                </div>
            </div>
        </div>

        <!-- å½“å‰é…ç½®åˆ—è¡¨ -->
        <div class="card">
            <h2>ğŸ“‹ å½“å‰é…ç½®</h2>
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>åŠ è½½ä¸­...</p>
            </div>
            <div id="config-list">
                <table class="table">
                    <thead>
                        <tr>
                            <th>é¡¹ç›®åç§°</th>
                            <th>Gitåœ°å€</th>
                            <th>æœºå™¨äºº</th>
                            <th>çŠ¶æ€</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="config-table-body">
                        <!-- åŠ¨æ€åŠ è½½ -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- æœºå™¨äººç®¡ç† -->
        <div class="card">
            <h2>ğŸ¤– æœºå™¨äººç®¡ç†</h2>
            <div id="bot-list">
                <table class="table">
                    <thead>
                        <tr>
                            <th>æœºå™¨äººID</th>
                            <th>åç§°</th>
                            <th>ç±»å‹</th>
                            <th>Webhook URL</th>
                            <th>çŠ¶æ€</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="bot-table-body">
                        <!-- åŠ¨æ€åŠ è½½ -->
                    </tbody>
                </table>
            </div>

            <div class="mt-3">
                <button type="button" id="add-custom-bot-btn" class="btn btn-primary">â• æ·»åŠ è‡ªå®šä¹‰æœºå™¨äºº</button>
                <button type="button" id="refresh-btn" class="btn btn-secondary">ğŸ”„ åˆ·æ–°æ•°æ®</button>
            </div>

            <!-- æ·»åŠ è‡ªå®šä¹‰æœºå™¨äººæ¨¡æ€æ¡† -->
            <div id="custom-bot-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 8px; width: 500px; max-width: 90%;">
                    <h3>â• æ·»åŠ è‡ªå®šä¹‰æœºå™¨äºº</h3>
                    <form id="custom-bot-form">
                        <div class="form-group">
                            <label for="modal-bot-name">æœºå™¨äººåç§°</label>
                            <input type="text" id="modal-bot-name" class="form-control" placeholder="ä¾‹å¦‚ï¼šé¡¹ç›®Aä¸“ç”¨æœºå™¨äºº" required>
                        </div>
                        <div class="form-group">
                            <label for="modal-webhook-url">Webhook URL</label>
                            <input type="url" id="modal-webhook-url" class="form-control" placeholder="https://open.larksuite.com/open-apis/bot/v2/hook/..." required>
                        </div>
                        <div class="text-center mt-3">
                            <button type="submit" class="btn btn-primary">ğŸ’¾ ä¿å­˜æœºå™¨äºº</button>
                            <button type="button" id="cancel-custom-bot" class="btn btn-secondary">âŒ å–æ¶ˆ</button>
                            <button type="button" id="test-custom-bot" class="btn btn-success">ğŸ§ª æµ‹è¯•è¿æ¥</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let bots = {};
        let mappings = {};

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadConfigStatus();
            loadBots();
            loadMappings();
            initEventListeners();
        });

        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
        function initEventListeners() {
            // Gitåœ°å€è¾“å…¥ç›‘å¬
            document.getElementById('git-url').addEventListener('input', function() {
                const url = this.value;
                if (url) {
                    extractProjectName(url);
                }
            });

            // æå–é¡¹ç›®åç§°æŒ‰é’®
            document.getElementById('extract-btn').addEventListener('click', function() {
                const url = document.getElementById('git-url').value;
                if (url) {
                    extractProjectName(url);
                } else {
                    showMessage('è¯·å…ˆè¾“å…¥Gitåœ°å€', 'danger');
                }
            });

            // æœºå™¨äººé€‰æ‹©ç›‘å¬
            document.getElementById('bot-select').addEventListener('change', function() {
                const botId = this.value;
                const customBotConfig = document.getElementById('custom-bot-config');
                const webhookUrl = document.getElementById('webhook-url');

                if (botId === 'custom') {
                    customBotConfig.style.display = 'block';
                    webhookUrl.readOnly = false;
                    webhookUrl.value = '';
                    webhookUrl.placeholder = 'è¯·è¾“å…¥è‡ªå®šä¹‰æœºå™¨äººçš„Webhook URL';
                } else {
                    customBotConfig.style.display = 'none';
                    webhookUrl.readOnly = true;
                    if (botId && bots[botId]) {
                        webhookUrl.value = bots[botId].webhook_url;
                    } else {
                        webhookUrl.value = '';
                    }
                }
            });

            // è¡¨å•æäº¤
            document.getElementById('add-config-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveConfig();
            });

            // æµ‹è¯•é…ç½®æŒ‰é’®
            document.getElementById('test-btn').addEventListener('click', function() {
                testConfig();
            });

            // æ‰¹é‡é¢„è§ˆæŒ‰é’®
            document.getElementById('batch-preview-btn').addEventListener('click', function() {
                previewBatchProjects();
            });

            // æ‰¹é‡æ·»åŠ æŒ‰é’®
            document.getElementById('batch-add-btn').addEventListener('click', function() {
                batchAddProjects();
            });

            // æ·»åŠ è‡ªå®šä¹‰æœºå™¨äººæŒ‰é’®
            document.getElementById('add-custom-bot-btn').addEventListener('click', function() {
                document.getElementById('custom-bot-modal').style.display = 'block';
            });

            // å–æ¶ˆè‡ªå®šä¹‰æœºå™¨äºº
            document.getElementById('cancel-custom-bot').addEventListener('click', function() {
                document.getElementById('custom-bot-modal').style.display = 'none';
                document.getElementById('custom-bot-form').reset();
            });

            // è‡ªå®šä¹‰æœºå™¨äººè¡¨å•æäº¤
            document.getElementById('custom-bot-form').addEventListener('submit', function(e) {
                e.preventDefault();
                addCustomBot();
            });

            // æµ‹è¯•è‡ªå®šä¹‰æœºå™¨äººè¿æ¥
            document.getElementById('test-custom-bot').addEventListener('click', function() {
                testCustomBotConnection();
            });

            // åˆ·æ–°æŒ‰é’®
            document.getElementById('refresh-btn').addEventListener('click', function() {
                loadBots();
                loadMappings();
            });
        }

        // æå–é¡¹ç›®åç§°
        function extractProjectName(gitUrl) {
            try {
                const url = new URL(gitUrl);
                const pathParts = url.pathname.split('/');
                let projectName = pathParts[pathParts.length - 1];
                
                // ç§»é™¤.gitåç¼€
                if (projectName.endsWith('.git')) {
                    projectName = projectName.slice(0, -4);
                }
                
                document.getElementById('project-name').value = projectName;
                document.getElementById('project-name').readOnly = false;
                
                showMessage(`é¡¹ç›®åç§°å·²æå–: ${projectName}`, 'success');
            } catch (error) {
                showMessage('Gitåœ°å€æ ¼å¼ä¸æ­£ç¡®', 'danger');
            }
        }

        // åŠ è½½é…ç½®çŠ¶æ€
        async function loadConfigStatus() {
            try {
                const response = await fetch('/config/status');
                const data = await response.json();

                if (data.status === 'success') {
                    const status = data.config_status;
                    const statusElement = document.getElementById('config-status');

                    let statusHtml = '';
                    if (status.environment === 'Docker') {
                        statusHtml = `
                            <span class="badge badge-success">ğŸ³ Dockerç¯å¢ƒ</span>
                            <span class="badge badge-primary">ğŸ’¾ é…ç½®æŒä¹…åŒ–</span>
                            <span class="badge badge-secondary">ğŸ¤– ${status.total_bots} ä¸ªæœºå™¨äºº</span>
                            <span class="badge badge-secondary">ğŸ“‹ ${status.total_mappings} ä¸ªæ˜ å°„</span>
                        `;
                    } else {
                        statusHtml = `
                            <span class="badge badge-info">ğŸ’» æœ¬åœ°ç¯å¢ƒ</span>
                            <span class="badge badge-secondary">ğŸ¤– ${status.total_bots} ä¸ªæœºå™¨äºº</span>
                            <span class="badge badge-secondary">ğŸ“‹ ${status.total_mappings} ä¸ªæ˜ å°„</span>
                        `;
                    }

                    statusElement.innerHTML = statusHtml;
                } else {
                    document.getElementById('config-status').innerHTML =
                        '<span class="badge badge-danger">âŒ çŠ¶æ€è·å–å¤±è´¥</span>';
                }
            } catch (error) {
                document.getElementById('config-status').innerHTML =
                    '<span class="badge badge-danger">âŒ ç½‘ç»œé”™è¯¯</span>';
            }
        }

        // åŠ è½½æœºå™¨äººåˆ—è¡¨
        async function loadBots() {
            try {
                const response = await fetch('/config/bots');
                const data = await response.json();
                
                if (data.status === 'success') {
                    bots = data.bots;
                    updateBotSelect();
                    updateBotTable();
                } else {
                    showMessage('åŠ è½½æœºå™¨äººåˆ—è¡¨å¤±è´¥: ' + data.message, 'danger');
                }
            } catch (error) {
                showMessage('ç½‘ç»œé”™è¯¯: ' + error.message, 'danger');
            }
        }

        // åŠ è½½æ˜ å°„é…ç½®
        async function loadMappings() {
            try {
                const response = await fetch('/config/mappings');
                const data = await response.json();
                
                if (data.status === 'success') {
                    mappings = data.mappings;
                    updateConfigTable();
                } else {
                    showMessage('åŠ è½½é…ç½®å¤±è´¥: ' + data.message, 'danger');
                }
            } catch (error) {
                showMessage('ç½‘ç»œé”™è¯¯: ' + error.message, 'danger');
            }
        }

        // æ›´æ–°æœºå™¨äººé€‰æ‹©æ¡†
        function updateBotSelect() {
            const select = document.getElementById('bot-select');
            const batchSelect = document.getElementById('batch-bot-select');

            select.innerHTML = '<option value="">è¯·é€‰æ‹©æœºå™¨äºº...</option><option value="custom">ğŸ”§ è‡ªå®šä¹‰æœºå™¨äºº</option>';
            batchSelect.innerHTML = '<option value="">è¯·é€‰æ‹©é»˜è®¤æœºå™¨äºº...</option>';

            for (const [botId, botConfig] of Object.entries(bots)) {
                const option = document.createElement('option');
                option.value = botId;
                option.textContent = `${botConfig.name} (${botId})`;
                select.appendChild(option);

                const batchOption = document.createElement('option');
                batchOption.value = botId;
                batchOption.textContent = `${botConfig.name} (${botId})`;
                batchSelect.appendChild(batchOption);
            }
        }

        // æ›´æ–°æœºå™¨äººè¡¨æ ¼
        function updateBotTable() {
            const tbody = document.getElementById('bot-table-body');
            tbody.innerHTML = '';

            for (const [botId, botConfig] of Object.entries(bots)) {
                const row = document.createElement('tr');
                const isCustom = botConfig.is_custom || false;

                // åˆ›å»ºæœºå™¨äººIDå•å…ƒæ ¼
                const idCell = document.createElement('td');
                idCell.innerHTML = `<span class="badge badge-primary">${botId}</span>`;

                // åˆ›å»ºåç§°å•å…ƒæ ¼
                const nameCell = document.createElement('td');
                nameCell.textContent = botConfig.name;

                // åˆ›å»ºç±»å‹å•å…ƒæ ¼
                const typeCell = document.createElement('td');
                if (isCustom) {
                    typeCell.innerHTML = '<span class="badge badge-info">è‡ªå®šä¹‰</span>';
                } else {
                    typeCell.innerHTML = '<span class="badge badge-secondary">é¢„é…ç½®</span>';
                }

                // åˆ›å»ºURLå•å…ƒæ ¼
                const urlCell = document.createElement('td');
                urlCell.innerHTML = `<code>${botConfig.webhook_url.substring(0, 50)}...</code>`;

                // åˆ›å»ºçŠ¶æ€å•å…ƒæ ¼
                const statusCell = document.createElement('td');
                statusCell.innerHTML = '<span class="badge badge-success">æ´»è·ƒ</span>';

                // åˆ›å»ºæ“ä½œå•å…ƒæ ¼
                const actionCell = document.createElement('td');

                // æµ‹è¯•æŒ‰é’®
                const testButton = document.createElement('button');
                testButton.className = 'btn btn-secondary';
                testButton.textContent = 'ğŸ§ª æµ‹è¯•';
                testButton.onclick = function() {
                    testBot(botId);
                };
                actionCell.appendChild(testButton);

                // åˆ é™¤æŒ‰é’®ï¼ˆä»…è‡ªå®šä¹‰æœºå™¨äººï¼‰
                if (isCustom) {
                    const deleteButton = document.createElement('button');
                    deleteButton.className = 'btn btn-danger';
                    deleteButton.textContent = 'ğŸ—‘ï¸ åˆ é™¤';
                    deleteButton.style.marginLeft = '5px';
                    deleteButton.onclick = function() {
                        deleteCustomBot(botId);
                    };
                    actionCell.appendChild(deleteButton);
                }

                // æ·»åŠ æ‰€æœ‰å•å…ƒæ ¼åˆ°è¡Œ
                row.appendChild(idCell);
                row.appendChild(nameCell);
                row.appendChild(typeCell);
                row.appendChild(urlCell);
                row.appendChild(statusCell);
                row.appendChild(actionCell);

                tbody.appendChild(row);
            }
        }

        // æ›´æ–°é…ç½®è¡¨æ ¼
        function updateConfigTable() {
            const tbody = document.getElementById('config-table-body');
            tbody.innerHTML = '';

            for (const [pattern, botId] of Object.entries(mappings)) {
                const botName = bots[botId] ? bots[botId].name : 'æœªçŸ¥æœºå™¨äºº';
                const row = document.createElement('tr');

                // åˆ›å»ºåˆ é™¤æŒ‰é’®ï¼Œé¿å…æ¨¡æ¿å­—ç¬¦ä¸²ä¸­çš„ç‰¹æ®Šå­—ç¬¦é—®é¢˜
                const deleteButton = document.createElement('button');
                deleteButton.className = 'btn btn-danger';
                deleteButton.textContent = 'ğŸ—‘ï¸ åˆ é™¤';
                deleteButton.onclick = function() {
                    deleteMapping(pattern);
                };

                // åˆ›å»ºè¡¨æ ¼è¡Œå†…å®¹
                const patternCell = document.createElement('td');
                const codeElement = document.createElement('code');
                codeElement.textContent = pattern;
                patternCell.appendChild(codeElement);

                const gitUrlCell = document.createElement('td');
                gitUrlCell.textContent = '-';

                const botCell = document.createElement('td');
                botCell.innerHTML = `${botName} <span class="badge badge-secondary">${botId}</span>`;

                const statusCell = document.createElement('td');
                statusCell.innerHTML = '<span class="badge badge-success">å·²é…ç½®</span>';

                const actionCell = document.createElement('td');
                actionCell.appendChild(deleteButton);

                // æ·»åŠ æ‰€æœ‰å•å…ƒæ ¼åˆ°è¡Œ
                row.appendChild(patternCell);
                row.appendChild(gitUrlCell);
                row.appendChild(botCell);
                row.appendChild(statusCell);
                row.appendChild(actionCell);

                tbody.appendChild(row);
            }
        }

        // ä¿å­˜é…ç½®
        async function saveConfig() {
            const gitUrl = document.getElementById('git-url').value;
            const projectName = document.getElementById('project-name').value;
            const botId = document.getElementById('bot-select').value;
            const webhookUrl = document.getElementById('webhook-url').value;
            const customBotName = document.getElementById('custom-bot-name').value;

            if (!gitUrl || !projectName || !botId) {
                showMessage('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯', 'danger');
                return;
            }

            // æ£€æŸ¥é¡¹ç›®æ˜¯å¦å·²å­˜åœ¨
            try {
                const checkResponse = await fetch('/config/projects/check', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        project_name: projectName
                    })
                });

                const checkData = await checkResponse.json();
                if (checkData.status === 'success' && checkData.result.exists) {
                    const existing = checkData.result;
                    const confirmUpdate = confirm(
                        `é¡¹ç›® "${projectName}" å·²ç»é…ç½®è¿‡ï¼\n` +
                        `å½“å‰æœºå™¨äººï¼š${existing.bot_name}\n` +
                        `å½“å‰URLï¼š${existing.webhook_url}\n\n` +
                        `æ˜¯å¦è¦ä¿®æ”¹é…ç½®ï¼Ÿï¼ˆéœ€è¦è¾“å…¥ç®¡ç†å‘˜å¯†ç ï¼‰`
                    );

                    if (confirmUpdate) {
                        const password = prompt('è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ï¼š');
                        if (!password) {
                            showMessage('æœªè¾“å…¥å¯†ç ï¼Œæ“ä½œå–æ¶ˆ', 'info');
                            return;
                        }

                        // æ‰§è¡Œç®¡ç†å‘˜æ“ä½œ
                        await adminUpdateProject(projectName, botId, password);
                        return;
                    } else {
                        showMessage('æ“ä½œå·²å–æ¶ˆ', 'info');
                        return;
                    }
                }
            } catch (error) {
                console.error('æ£€æŸ¥é¡¹ç›®å¤±è´¥:', error);
            }

            // å¦‚æœæ˜¯è‡ªå®šä¹‰æœºå™¨äººï¼Œå…ˆåˆ›å»ºæœºå™¨äºº
            let finalBotId = botId;
            if (botId === 'custom') {
                if (!customBotName || !webhookUrl) {
                    showMessage('è¯·å¡«å†™è‡ªå®šä¹‰æœºå™¨äººåç§°å’ŒWebhook URL', 'danger');
                    return;
                }

                finalBotId = await createCustomBot(customBotName, webhookUrl);
                if (!finalBotId) {
                    return; // åˆ›å»ºå¤±è´¥ï¼Œé”™è¯¯ä¿¡æ¯å·²åœ¨createCustomBotä¸­æ˜¾ç¤º
                }
            }

            try {
                const response = await fetch('/config/mapping', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        project_name: projectName,
                        git_url: gitUrl,
                        bot_id: finalBotId,
                        webhook_url: webhookUrl
                    })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    showMessage('é…ç½®ä¿å­˜æˆåŠŸï¼', 'success');
                    document.getElementById('add-config-form').reset();
                    document.getElementById('custom-bot-config').style.display = 'none';
                    loadMappings(); // é‡æ–°åŠ è½½é…ç½®
                    loadBots(); // é‡æ–°åŠ è½½æœºå™¨äººåˆ—è¡¨
                } else {
                    showMessage('ä¿å­˜å¤±è´¥: ' + data.message, 'danger');
                }
            } catch (error) {
                showMessage('ç½‘ç»œé”™è¯¯: ' + error.message, 'danger');
            }
        }

        // æµ‹è¯•é…ç½®
        async function testConfig() {
            const projectName = document.getElementById('project-name').value;
            
            if (!projectName) {
                showMessage('è¯·å…ˆè¾“å…¥é¡¹ç›®åç§°', 'danger');
                return;
            }

            try {
                const response = await fetch(`/config/test/${projectName}`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    showMessage(`æµ‹è¯•æˆåŠŸï¼é¡¹ç›® ${projectName} å°†ä½¿ç”¨æœºå™¨äºº: ${data.bot_config.name}`, 'success');
                } else {
                    showMessage('æµ‹è¯•å¤±è´¥: ' + data.message, 'danger');
                }
            } catch (error) {
                showMessage('ç½‘ç»œé”™è¯¯: ' + error.message, 'danger');
            }
        }

        // åˆ é™¤æ˜ å°„
        async function deleteMapping(pattern) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤æ˜ å°„ "${pattern}" å—ï¼Ÿ`)) {
                return;
            }

            try {
                const response = await fetch('/config/mapping', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        pattern: pattern
                    })
                });

                const data = await response.json();
                
                if (data.status === 'success') {
                    showMessage('æ˜ å°„åˆ é™¤æˆåŠŸï¼', 'success');
                    loadMappings(); // é‡æ–°åŠ è½½é…ç½®
                } else {
                    showMessage('åˆ é™¤å¤±è´¥: ' + data.message, 'danger');
                }
            } catch (error) {
                showMessage('ç½‘ç»œé”™è¯¯: ' + error.message, 'danger');
            }
        }

        // æµ‹è¯•æœºå™¨äºº
        async function testBot(botId) {
            showMessage(`æ­£åœ¨æµ‹è¯•æœºå™¨äºº ${botId}...`, 'info');
            
            try {
                const response = await fetch(`/config/bot/test/${botId}`, {
                    method: 'POST'
                });

                const data = await response.json();
                
                if (data.status === 'success') {
                    showMessage(`æœºå™¨äºº ${botId} æµ‹è¯•æˆåŠŸï¼`, 'success');
                } else {
                    showMessage(`æœºå™¨äºº ${botId} æµ‹è¯•å¤±è´¥: ${data.message}`, 'danger');
                }
            } catch (error) {
                showMessage('ç½‘ç»œé”™è¯¯: ' + error.message, 'danger');
            }
        }

        // åˆ›å»ºè‡ªå®šä¹‰æœºå™¨äºº
        async function createCustomBot(name, webhookUrl) {
            try {
                const response = await fetch('/config/bot/custom', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: name,
                        webhook_url: webhookUrl
                    })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    showMessage(`è‡ªå®šä¹‰æœºå™¨äºº "${name}" åˆ›å»ºæˆåŠŸï¼`, 'success');
                    return data.bot_id;
                } else {
                    showMessage('åˆ›å»ºè‡ªå®šä¹‰æœºå™¨äººå¤±è´¥: ' + data.message, 'danger');
                    return null;
                }
            } catch (error) {
                showMessage('ç½‘ç»œé”™è¯¯: ' + error.message, 'danger');
                return null;
            }
        }

        // ç®¡ç†å‘˜æ›´æ–°é¡¹ç›®é…ç½®
        async function adminUpdateProject(projectName, botId, password) {
            try {
                const response = await fetch('/config/admin/action', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        password: password,
                        action: 'update_project',
                        data: {
                            project_name: projectName,
                            bot_id: botId
                        }
                    })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    showMessage('é¡¹ç›®é…ç½®æ›´æ–°æˆåŠŸï¼', 'success');
                    document.getElementById('add-config-form').reset();
                    loadMappings();
                } else {
                    showMessage('æ›´æ–°å¤±è´¥: ' + data.message, 'danger');
                }
            } catch (error) {
                showMessage('ç½‘ç»œé”™è¯¯: ' + error.message, 'danger');
            }
        }

        // é¢„è§ˆæ‰¹é‡é¡¹ç›®
        function previewBatchProjects() {
            const batchText = document.getElementById('batch-projects').value.trim();
            if (!batchText) {
                showMessage('è¯·è¾“å…¥Gitåœ°å€', 'danger');
                return;
            }

            const urls = batchText.split('\n').filter(url => url.trim());
            const projects = [];

            for (const url of urls) {
                try {
                    const urlObj = new URL(url.trim());
                    const pathParts = urlObj.pathname.split('/');
                    let projectName = pathParts[pathParts.length - 1];

                    if (projectName.endsWith('.git')) {
                        projectName = projectName.slice(0, -4);
                    }

                    projects.push({
                        name: projectName,
                        git_url: url.trim()
                    });
                } catch (error) {
                    projects.push({
                        name: 'è§£æå¤±è´¥',
                        git_url: url.trim(),
                        error: 'æ— æ•ˆçš„Gitåœ°å€'
                    });
                }
            }

            // æ˜¾ç¤ºé¢„è§ˆç»“æœ
            const previewDiv = document.getElementById('batch-preview');
            const contentDiv = document.getElementById('batch-preview-content');

            let html = '<table class="table"><thead><tr><th>é¡¹ç›®åç§°</th><th>Gitåœ°å€</th><th>çŠ¶æ€</th></tr></thead><tbody>';

            for (const project of projects) {
                const statusClass = project.error ? 'danger' : 'success';
                const status = project.error || 'âœ… å‡†å¤‡æ·»åŠ ';
                html += `<tr><td>${project.name}</td><td><code>${project.git_url}</code></td><td><span class="badge badge-${statusClass}">${status}</span></td></tr>`;
            }

            html += '</tbody></table>';
            contentDiv.innerHTML = html;
            previewDiv.style.display = 'block';

            showMessage(`é¢„è§ˆå®Œæˆï¼šå…± ${projects.length} ä¸ªé¡¹ç›®`, 'info');
        }

        // æ‰¹é‡æ·»åŠ é¡¹ç›®
        async function batchAddProjects() {
            const batchText = document.getElementById('batch-projects').value.trim();
            const defaultBotId = document.getElementById('batch-bot-select').value;

            if (!batchText) {
                showMessage('è¯·è¾“å…¥Gitåœ°å€', 'danger');
                return;
            }

            if (!defaultBotId) {
                showMessage('è¯·é€‰æ‹©é»˜è®¤æœºå™¨äºº', 'danger');
                return;
            }

            const urls = batchText.split('\n').filter(url => url.trim());
            const projects = [];

            for (const url of urls) {
                try {
                    const urlObj = new URL(url.trim());
                    const pathParts = urlObj.pathname.split('/');
                    let projectName = pathParts[pathParts.length - 1];

                    if (projectName.endsWith('.git')) {
                        projectName = projectName.slice(0, -4);
                    }

                    projects.push({
                        name: projectName,
                        git_url: url.trim(),
                        bot_id: defaultBotId
                    });
                } catch (error) {
                    console.error('è§£æGitåœ°å€å¤±è´¥:', url, error);
                }
            }

            try {
                const response = await fetch('/config/projects/batch', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        projects: projects,
                        default_bot_id: defaultBotId
                    })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    const results = data.results;
                    let message = `æ‰¹é‡æ·»åŠ å®Œæˆï¼\n`;
                    message += `âœ… æˆåŠŸï¼š${results.success.length} ä¸ª\n`;
                    message += `âŒ å¤±è´¥ï¼š${results.failed.length} ä¸ª\n`;
                    message += `âš ï¸ å·²å­˜åœ¨ï¼š${results.existing.length} ä¸ª`;

                    if (results.existing.length > 0) {
                        message += '\n\nå·²å­˜åœ¨çš„é¡¹ç›®ï¼š\n';
                        for (const existing of results.existing) {
                            message += `â€¢ ${existing.project_name} (${existing.current_bot})\n`;
                        }
                    }

                    showMessage(message, 'success');
                    document.getElementById('batch-projects').value = '';
                    document.getElementById('batch-preview').style.display = 'none';
                    loadMappings();
                } else {
                    showMessage('æ‰¹é‡æ·»åŠ å¤±è´¥: ' + data.message, 'danger');
                }
            } catch (error) {
                showMessage('ç½‘ç»œé”™è¯¯: ' + error.message, 'danger');
            }
        }

        // æ·»åŠ è‡ªå®šä¹‰æœºå™¨äººï¼ˆæ¨¡æ€æ¡†ï¼‰
        async function addCustomBot() {
            const name = document.getElementById('modal-bot-name').value;
            const webhookUrl = document.getElementById('modal-webhook-url').value;

            if (!name || !webhookUrl) {
                showMessage('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯', 'danger');
                return;
            }

            const botId = await createCustomBot(name, webhookUrl);
            if (botId) {
                document.getElementById('custom-bot-modal').style.display = 'none';
                document.getElementById('custom-bot-form').reset();
                loadBots();
            }
        }

        // æµ‹è¯•è‡ªå®šä¹‰æœºå™¨äººè¿æ¥
        async function testCustomBotConnection() {
            const webhookUrl = document.getElementById('modal-webhook-url').value;

            if (!webhookUrl) {
                showMessage('è¯·å…ˆè¾“å…¥Webhook URL', 'danger');
                return;
            }

            // è¿™é‡Œå¯ä»¥æ·»åŠ æµ‹è¯•è¿æ¥çš„é€»è¾‘
            showMessage('æµ‹è¯•åŠŸèƒ½å¼€å‘ä¸­...', 'info');
        }

        // åˆ é™¤è‡ªå®šä¹‰æœºå™¨äºº
        async function deleteCustomBot(botId) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤è‡ªå®šä¹‰æœºå™¨äºº "${botId}" å—ï¼Ÿ`)) {
                return;
            }

            const password = prompt('è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ï¼š');
            if (!password) {
                showMessage('æœªè¾“å…¥å¯†ç ï¼Œæ“ä½œå–æ¶ˆ', 'info');
                return;
            }

            try {
                const response = await fetch('/config/admin/action', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        password: password,
                        action: 'delete_custom_bot',
                        data: {
                            bot_id: botId
                        }
                    })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    showMessage('è‡ªå®šä¹‰æœºå™¨äººåˆ é™¤æˆåŠŸï¼', 'success');
                    loadBots();
                } else {
                    showMessage('åˆ é™¤å¤±è´¥: ' + data.message, 'danger');
                }
            } catch (error) {
                showMessage('ç½‘ç»œé”™è¯¯: ' + error.message, 'danger');
            }
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type) {
            const messageArea = document.getElementById('message-area');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.style.whiteSpace = 'pre-line'; // æ”¯æŒæ¢è¡Œ
            alertDiv.textContent = message;

            messageArea.innerHTML = '';
            messageArea.appendChild(alertDiv);

            // 5ç§’åè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }
    </script>
</body>
</html>
